#!/usr/bin/env bash
set -euo pipefail

cache="${XDG_CACHE_HOME:-$HOME/.cache}/emoji.tsv"
if [ ! -s "$cache" ]; then
  "${TOFI_EMOJI_CACHE_HELPER:-tofi-emoji-cache}"
fi

args=("$@")
has_prompt=0
has_require_match=0

idx=0
while [ "$idx" -lt "${#args[@]}" ]; do
  current="${args[$idx]}"
  case "$current" in
    --prompt|-p|--prompt=*)
      has_prompt=1
      ;;
    --require-match|--require-match=*)
      has_require_match=1
      ;;
  esac

  if [ "$current" = "--prompt" ] || [ "$current" = "-p" ] || [ "$current" = "--require-match" ]; then
    idx=$((idx + 1))
  fi

  idx=$((idx + 1))
done

if [ "$has_prompt" -eq 0 ]; then
  args+=("--prompt" "emoji")
fi

if [ "$has_require_match" -eq 0 ]; then
  args+=("--require-match=true")
fi

choice="$(cut -f1,2 "$cache" | sed 's/\t/  /' | tofi "${args[@]}")"
[ -n "${choice:-}" ] || exit 0

glyph="${choice%% *}"
wl-copy -n "$glyph"
